#!/usr/bin/env ruby

if $0 == __FILE__
  $:.unshift File.expand_path('../../ext', __FILE__)
  $:.unshift File.expand_path('../../lib', __FILE__)
end

require 'xcodeproj'

require 'optparse'

module Xcodeproj
  class Bin
    def initialize(argv)
      @argv = parse_options!(argv)
    end

    def run
      case @argv.shift
      when 'targets-diff'
        targets_diff
      else
        puts @option_parser
      end
    end

    protected

    def xcodeproj_path
      unless @xcodeproj_path
        projects = Dir.glob('*.xcodeproj')
        if projects.size == 1
          xcodeproj_path = projects.first
        elsif projects.size > 1
          invalid_command('There are more than one Xcode project documents ' \
                          'in the current working directory. Please specify ' \
                          'which to use with the `--project` option.')
        else
          invalid_command('No Xcode project document found in the current ' \
                          'working directory. Please specify which to use ' \
                          'with the `--project` option.')
        end
        @xcodeproj_path = File.expand_path(xcodeproj_path)
      end
      @xcodeproj_path
    end

    def xcodeproj
      @xcodeproj ||= Project.new(xcodeproj_path)
    end

    def targets_diff
      require 'yaml'
      differ = Helper::TargetDiff.new(xcodeproj, @argv[0], @argv[1])
      files = differ.new_source_build_files.map do |build_file|
        {
          'Name' => build_file.file_ref.name,
          'Path' => build_file.file_ref.path,
          'Build settings' => build_file.settings,
        }
      end
      puts files.to_yaml
    end

    private

    def invalid_command(msg)
      puts msg
      exit 1
    end

    def parse_options!(argv)
      @option_parser = OptionParser.new do |opts|
        opts.banner  = "Usage: xcodeproj [command] [options]"
        opts.separator ""
        opts.separator "Commands:"
        opts.separator ""
        opts.separator "  targets-diff [target 1] [target 2]\tShows the difference between two targets. (Only build source files atm.)"
        opts.separator ""

        opts.separator "Options:"
        opts.separator ""

        opts.on('--project PATH', "The Xcode project document to use.") do |xcodeproj_path|
          @xcodeproj_path = File.expand_path(xcodeproj_path)
        end

        opts.on("--version", "Show xcodeproj version.") do |v|
          puts Xcodeproj::VERSION
          exit
        end
      end
      remainder = argv.dup
      @option_parser.parse!(remainder)
      remainder
    end
  end
end

Xcodeproj::Bin.new(ARGV).run
